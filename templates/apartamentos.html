{% extends "base.html" %}
{% block title %}Apartamentos - Xpack{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-building"></i> Apartamentos</h1>
    <button class="btn btn-primary" onclick="wizardApt.open()">
        <i class="bi bi-plus-lg"></i> Nuevo Apartamento
    </button>
</div>

<!-- Lista de Apartamentos -->
<div class="card">
    <div class="card-body">
        {% if apartments %}
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Apto</th>
                        <th>Piso</th>
                        <th>Residente</th>
                        <th>Tipo</th>
                        <th>Contacto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for apt in pagination.items %}
                    <tr>
                        <td data-label="Apto"><strong>{{ apt.number }}</strong></td>
                        <td data-label="Piso">{{ apt.floor or '-' }}</td>
                        <td data-label="Residente">
                            {{ apt.resident_name or '-' }}
                            {% if apt.extra_residents %}
                            <br><small class="text-muted"><i class="bi bi-people-fill"></i> +{{ apt.extra_residents|length }} residente(s) más</small>
                            {% endif %}
                        </td>
                        <td data-label="Tipo">
                            {% if apt.resident_role == 'owner' %}
                                <span class="badge-status badge-active"><i class="bi bi-house-fill"></i> Propietario</span>
                            {% elif apt.resident_name %}
                                <span class="badge-status badge-pending"><i class="bi bi-person"></i> Inquilino</span>
                            {% else %}
                                <span class="badge-status badge-inactive">Vacío</span>
                            {% endif %}
                        </td>
                        <td data-label="Contacto">
                            <small>
                                {% if apt.resident_email %}<i class="bi bi-envelope"></i> {{ apt.resident_email }}<br>{% endif %}
                                {% if apt.resident_phone %}<i class="bi bi-phone"></i> {{ apt.resident_phone }}{% endif %}
                            </small>
                        </td>
                        <td data-label="Acciones">
                            <button class="btn-action edit" onclick="editApt({{ apt | tojson }})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{ url_for('apartments.delete', id=apt.id) }}" style="display:inline;" 
                                  onsubmit="return confirm('¿Eliminar apartamento {{ apt.number }}?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn-action delete" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <nav class="mt-3">
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% for page in range(1, pagination.pages + 1) %}
                <li class="page-item {% if page == pagination.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ page }}">{{ page }}</a>
                </li>
                {% endfor %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <i class="bi bi-building"></i>
            <p>No hay apartamentos registrados</p>
            <button class="btn btn-primary mt-2" onclick="wizardApt.open()">
                <i class="bi bi-plus-lg"></i> Crear Primer Apartamento
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- ===== WIZARD: Nuevo Apartamento ===== -->
<div class="wizard-overlay" id="wizardAptOverlay">
    <div class="wizard-container" id="wizardAptContainer">
        <div class="wizard-header">
            <div class="wizard-title"><i class="bi bi-building"></i> Nuevo Apartamento</div>
            <button class="wizard-close"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="wizard-progress">
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
        </div>
        <div class="wizard-step-counter"></div>

        <form method="POST" action="{{ url_for('apartments.add') }}" id="formAddApt">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="wizard-body">
                <!-- Step 1: Número -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Identificación</div>
                    <div class="wizard-step-title">¿Cuál es el número del apartamento?</div>
                    <input type="text" name="number" class="wizard-input" placeholder="Ej: 101, A-1, PH2..." required autofocus>
                    <div class="mt-3">
                        <label class="wizard-step-label">Piso (opcional)</label>
                        <input type="text" name="floor" class="wizard-input" placeholder="Ej: 1, 2, PB...">
                    </div>
                </div>

                <!-- Step 2: Residentes -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Residentes</div>
                    <div class="wizard-step-title">¿Quién vive aquí?</div>
                    <div class="mb-1"><small class="text-muted"><i class="bi bi-person-fill"></i> Residente Principal <span class="text-danger">*</span></small></div>
                    <input type="text" name="resident_name" class="wizard-input" placeholder="Nombre completo del residente" required>
                    <div class="mt-2">
                        <label class="wizard-step-label">Tipo de residente</label>
                        <select name="resident_role" class="wizard-select">
                            <option value="tenant">Inquilino</option>
                            <option value="owner">Propietario</option>
                        </select>
                    </div>
                    <div id="extraResidentsAdd"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-3 w-100" id="btnAddExtraResident">
                        <i class="bi bi-plus-circle"></i> Agregar otro residente (opcional)
                    </button>
                </div>

                <!-- Step 3: Contacto -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Contacto</div>
                    <div class="wizard-step-title">¿Cómo contactamos al residente?</div>
                    <input type="email" name="resident_email" class="wizard-input" placeholder="correo@ejemplo.com">
                    <div class="mt-3">
                        <label class="wizard-step-label">Teléfono</label>
                        <input type="tel" name="resident_phone" class="wizard-input" placeholder="+1 (809) 000-0000">
                    </div>
                    <div class="mt-3">
                        <label class="wizard-step-label">Términos de pago (días)</label>
                        <input type="number" name="payment_terms" class="wizard-input" value="30" min="1" max="365">
                    </div>
                </div>

                <!-- Step 4: Notas + Resumen -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Resumen</div>
                    <div class="wizard-step-title">Todo listo, verifica los datos</div>
                    <textarea name="notes" class="wizard-textarea" placeholder="Notas adicionales (opcional)" rows="2"></textarea>
                    <div class="wizard-summary mt-3" id="aptSummary"></div>
                </div>
            </div>

            <div class="wizard-footer">
                <button type="button" class="wizard-btn wizard-btn-back"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button type="button" class="wizard-btn wizard-btn-next">Siguiente <i class="bi bi-arrow-right"></i></button>
                <button type="submit" class="wizard-btn wizard-btn-submit"><i class="bi bi-check-lg"></i> Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== WIZARD: Editar Apartamento ===== -->
<div class="wizard-overlay" id="wizardEditAptOverlay">
    <div class="wizard-container" id="wizardEditAptContainer">
        <div class="wizard-header">
            <div class="wizard-title"><i class="bi bi-pencil"></i> Editar Apartamento</div>
            <button class="wizard-close"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="wizard-progress">
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
        </div>
        <div class="wizard-step-counter"></div>

        <form method="POST" id="formEditApt">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="wizard-body">
                <!-- Step 1: Número -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Identificación</div>
                    <div class="wizard-step-title">Apartamento</div>
                    <input type="text" name="number" class="wizard-input" id="editNumber" required>
                    <div class="mt-3">
                        <label class="wizard-step-label">Piso</label>
                        <input type="text" name="floor" class="wizard-input" id="editFloor">
                    </div>
                </div>

                <!-- Step 2: Residentes -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Residentes</div>
                    <div class="wizard-step-title">Datos del residente</div>
                    <div class="mb-1"><small class="text-muted"><i class="bi bi-person-fill"></i> Residente Principal <span class="text-danger">*</span></small></div>
                    <input type="text" name="resident_name" class="wizard-input" id="editResidentName" placeholder="Nombre del residente" required>
                    <div class="mt-2">
                        <label class="wizard-step-label">Tipo</label>
                        <select name="resident_role" class="wizard-select" id="editResidentRole">
                            <option value="tenant">Inquilino</option>
                            <option value="owner">Propietario</option>
                        </select>
                    </div>
                    <div id="extraResidentsEdit"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-3 w-100" id="btnAddExtraResidentEdit">
                        <i class="bi bi-plus-circle"></i> Agregar otro residente (opcional)
                    </button>
                </div>

                <!-- Step 3: Contacto -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Contacto</div>
                    <div class="wizard-step-title">Información de contacto</div>
                    <input type="email" name="resident_email" class="wizard-input" id="editEmail" placeholder="correo@ejemplo.com">
                    <div class="mt-3">
                        <label class="wizard-step-label">Teléfono</label>
                        <input type="tel" name="resident_phone" class="wizard-input" id="editPhone">
                    </div>
                    <div class="mt-3">
                        <label class="wizard-step-label">Términos de pago (días)</label>
                        <input type="number" name="payment_terms" class="wizard-input" id="editPaymentTerms" value="30">
                    </div>
                    <div class="mt-3">
                        <label class="wizard-step-label">Notas</label>
                        <textarea name="notes" class="wizard-textarea" id="editNotes" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="wizard-footer">
                <button type="button" class="wizard-btn wizard-btn-back"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button type="button" class="wizard-btn wizard-btn-next">Siguiente <i class="bi bi-arrow-right"></i></button>
                <button type="submit" class="wizard-btn wizard-btn-submit"><i class="bi bi-check-lg"></i> Guardar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Helper: construir bloque de residente adicional
function buildExtraResidentBlock(containerId, idx, data) {
    data = data || {};
    const tenantSel = (data.role || 'tenant') === 'tenant' ? 'selected' : '';
    const ownerSel = data.role === 'owner' ? 'selected' : '';
    return `<div class="mt-3 p-2 border rounded" id="extra_${containerId}_${idx}" style="background:var(--sidebar-hover,#f8f9fa);">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted"><i class="bi bi-person"></i> Residente adicional ${idx}</small>
            <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1" onclick="document.getElementById('extra_${containerId}_${idx}').remove()"><i class="bi bi-x"></i></button>
        </div>
        <input type="text" name="extra_name[]" class="wizard-input mb-2" placeholder="Nombre completo" value="${data.name || ''}">
        <select name="extra_role[]" class="wizard-select mb-2">
            <option value="tenant" ${tenantSel}>Inquilino</option>
            <option value="owner" ${ownerSel}>Propietario</option>
        </select>
        <input type="email" name="extra_email[]" class="wizard-input mb-2" placeholder="Email (opcional)" value="${data.email || ''}">
        <input type="tel" name="extra_phone[]" class="wizard-input" placeholder="Teléfono (opcional)" value="${data.phone || ''}">
    </div>`;
}

// Create Wizard
const wizardApt = new XpackWizard('wizardAptContainer', {
    onStepChange: function(step, data) {
        if (step === 3) { // Summary step
            const form = document.getElementById('formAddApt');
            const fd = new FormData(form);
            let html = '';
            const fields = [
                ['Número', 'number'], ['Piso', 'floor'], 
                ['Residente', 'resident_name'], ['Tipo', 'resident_role'],
                ['Email', 'resident_email'], ['Teléfono', 'resident_phone'],
                ['Términos', 'payment_terms']
            ];
            fields.forEach(([label, key]) => {
                const val = fd.get(key) || '-';
                html += `<div class="wizard-summary-item">
                    <span class="wizard-summary-label">${label}</span>
                    <span class="wizard-summary-value">${val}</span>
                </div>`;
            });
            document.getElementById('aptSummary').innerHTML = html;
        }
    }
});

let extraAddCount = 0;
document.getElementById('btnAddExtraResident').addEventListener('click', function() {
    extraAddCount++;
    document.getElementById('extraResidentsAdd').insertAdjacentHTML('beforeend', buildExtraResidentBlock('add', extraAddCount));
});

// Edit Wizard
const wizardEditApt = new XpackWizard('wizardEditAptContainer');

let extraEditCount = 0;
document.getElementById('btnAddExtraResidentEdit').addEventListener('click', function() {
    extraEditCount++;
    document.getElementById('extraResidentsEdit').insertAdjacentHTML('beforeend', buildExtraResidentBlock('edit', extraEditCount));
});

function editApt(apt) {
    const form = document.getElementById('formEditApt');
    form.action = '/apartamentos/edit/' + apt.id;
    document.getElementById('editNumber').value = apt.number || '';
    document.getElementById('editFloor').value = apt.floor || '';
    document.getElementById('editResidentName').value = apt.resident_name || '';
    document.getElementById('editResidentRole').value = apt.resident_role || 'tenant';
    document.getElementById('editEmail').value = apt.resident_email || '';
    document.getElementById('editPhone').value = apt.resident_phone || '';
    document.getElementById('editPaymentTerms').value = apt.payment_terms || 30;
    document.getElementById('editNotes').value = apt.notes || '';
    // Cargar residentes adicionales existentes
    const container = document.getElementById('extraResidentsEdit');
    container.innerHTML = '';
    extraEditCount = 0;
    const extras = apt.extra_residents || [];
    extras.forEach(function(r) {
        extraEditCount++;
        container.insertAdjacentHTML('beforeend', buildExtraResidentBlock('edit', extraEditCount, r));
    });
    wizardEditApt.open();
}
</script>
{% endblock %}
