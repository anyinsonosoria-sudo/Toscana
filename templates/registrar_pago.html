{% extends "base.html" %}
{% block title %}Registrar Pago - Xpack{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-cash-coin"></i> Registrar Pago</h1>
</div>

<!-- Facturas Pendientes -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-clock" style="color: var(--warning);"></i> Facturas Pendientes de Pago
    </div>
    <div class="card-body">
        {% if invoices %}
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Cliente</th>
                        <th>Descripción</th>
                        <th>Total</th>
                        <th>Pagado</th>
                        <th>Balance</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in invoices %}
                    <tr>
                        <td data-label="#"><strong>#{{ inv.id }}</strong></td>
                        <td data-label="Cliente">
                            <div style="font-weight:600;">{{ inv.client_name or 'N/A' }}</div>
                            <small style="color:var(--text-muted);">Apto {{ inv.apartment_number or '?' }}</small>
                        </td>
                        <td data-label="Descripción">{{ inv.description or '-' }}</td>
                        <td data-label="Total">RD$ {{ "{:,.2f}".format(inv.amount or 0) }}</td>
                        <td data-label="Pagado" style="color: var(--success);">RD$ {{ "{:,.2f}".format(inv.total_paid or 0) }}</td>
                        <td data-label="Balance" style="font-weight: 700; color: var(--danger);">RD$ {{ "{:,.2f}".format(inv.remaining or inv.amount or 0) }}</td>
                        <td data-label="Acción">
                            <button class="btn btn-sm btn-success" onclick="openPayment({{ inv.id }}, {{ inv.amount }}, {{ inv.total_paid or 0 }}, {{ (inv.remaining or inv.amount or 0)|round(2) }}, '{{ (inv.client_name or 'N/A')|e }}', '{{ (inv.apartment_number or '?')|e }}')">
                                <i class="bi bi-cash-coin"></i> Pagar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-check-circle" style="color: var(--success);"></i>
            <p>No hay facturas pendientes de pago</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Pagos Recientes -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-clock-history" style="color: var(--primary);"></i> Pagos Recientes
    </div>
    <div class="card-body">
        {% if payments %}
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Factura</th>
                        <th>Cliente</th>
                        <th>Apto</th>
                        <th>Monto</th>
                        <th>Método</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in payments %}
                    <tr>
                        <td data-label="#">{{ p.id }}</td>
                        <td data-label="Factura"><strong>#{{ p.invoice_id }}</strong></td>
                        <td data-label="Cliente">{{ p.client_name or '-' }}</td>
                        <td data-label="Apto">{{ p.apartment_number or '-' }}</td>
                        <td data-label="Monto" style="font-weight: 700; color: var(--success);">RD$ {{ "{:,.2f}".format(p.amount or 0) }}</td>
                        <td data-label="Método"><span class="badge-status badge-active">{{ p.method or '-' }}</span></td>
                        <td data-label="Fecha"><small>{{ p.paid_date or '-' }}</small></td>
                        <td data-label="Acciones">
                            <form method="POST" action="{{ url_for('billing.delete_payment', payment_id=p.id) }}" style="display:inline;"
                                  onsubmit="return confirm('¿Eliminar pago #{{ p.id }}?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn-action delete" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="padding: 1.5rem;">
            <i class="bi bi-inbox"></i>
            <p>No hay pagos registrados aún</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- ===== WIZARD: Pago (mismo componente unificado) ===== -->
<div class="wizard-overlay" id="wizardPayOverlay">
    <div class="wizard-container" id="wizardPayContainer">
        <div class="wizard-header">
            <div class="wizard-title"><i class="bi bi-cash-coin"></i> Aplicar Pago</div>
            <button class="wizard-close"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="wizard-progress">
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
            <div class="wizard-progress-step"></div>
        </div>
        <div class="wizard-step-counter"></div>

        <form method="POST" id="formQuickPay">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="wizard-body">
                <!-- Step 1: Info de factura -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Factura</div>
                    <div class="wizard-step-title">Detalle de la factura</div>
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:1rem;">
                        <div class="d-flex justify-content-between mb-2">
                            <span style="color:var(--text-muted);font-size:0.85rem;">Cliente</span>
                            <strong id="payClientName">-</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span style="color:var(--text-muted);font-size:0.85rem;">Apartamento</span>
                            <span id="payAptNumber">-</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span style="color:var(--text-muted);font-size:0.85rem;">Total Factura</span>
                            <span id="payInvAmount">RD$ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span style="color:var(--text-muted);font-size:0.85rem;">Ya Pagado</span>
                            <span style="color:var(--success);" id="payPaidAmt">RD$ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between" style="border-top:2px solid var(--primary);padding-top:0.5rem;margin-top:0.25rem;">
                            <strong style="color:var(--primary);">Balance Pendiente</strong>
                            <strong style="color:var(--danger);font-size:1.1rem;" id="payBalance">RD$ 0.00</strong>
                        </div>
                    </div>
                </div>
                <!-- Step 2: Monto -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Monto</div>
                    <div class="wizard-step-title">¿Cuánto recibe?</div>
                    <div class="text-center mb-2" style="font-size: 0.85rem; color: var(--gray-500);">
                        Balance pendiente: <strong id="payBalanceHint" style="color:var(--danger);">RD$ 0.00</strong>
                    </div>
                    <input type="number" name="received_amount" id="payAmountInput" class="wizard-input" step="0.01" min="0.01" placeholder="Monto recibido" required
                           style="text-align:center;font-size:1.5rem;font-weight:700;">
                </div>
                <!-- Step 3: Método -->
                <div class="wizard-step">
                    <div class="wizard-step-label">Método</div>
                    <div class="wizard-step-title">¿Cómo paga el cliente?</div>
                    <select name="method" class="wizard-select">
                        <option value="transferencia">Transferencia</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="cheque">Cheque</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                    <div class="mt-3">
                        <label class="wizard-step-label">Notas (opcional)</label>
                        <textarea name="notes" class="wizard-textarea" rows="2" placeholder="Referencia, número de cheque, etc."></textarea>
                    </div>
                </div>
            </div>
            <div class="wizard-footer">
                <button type="button" class="wizard-btn wizard-btn-back"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button type="button" class="wizard-btn wizard-btn-next">Siguiente <i class="bi bi-arrow-right"></i></button>
                <button type="submit" class="wizard-btn wizard-btn-submit"><i class="bi bi-check-lg"></i> Registrar Pago</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function fmtRD(n) {
    return 'RD$ ' + Number(n || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

const wizardPay = new XpackWizard('wizardPayContainer');

function openPayment(invoiceId, totalAmount, paidAmount, balance, clientName, aptNumber) {
    const form = document.getElementById('formQuickPay');
    form.action = '/ventas/facturas/partial-payment/' + invoiceId;
    document.getElementById('payInvAmount').textContent = fmtRD(totalAmount);
    document.getElementById('payPaidAmt').textContent = fmtRD(paidAmount || 0);
    document.getElementById('payBalance').textContent = fmtRD(balance || totalAmount);
    document.getElementById('payBalanceHint').textContent = fmtRD(balance || totalAmount);
    document.getElementById('payClientName').textContent = clientName || 'N/A';
    document.getElementById('payAptNumber').textContent = aptNumber ? ('Apto ' + aptNumber) : '-';
    const amtInput = document.getElementById('payAmountInput');
    amtInput.max = balance || totalAmount;
    amtInput.value = '';
    form.querySelector('select[name="method"]').selectedIndex = 0;
    form.querySelector('textarea[name="notes"]').value = '';
    wizardPay.open();
}
</script>
{% endblock %}
