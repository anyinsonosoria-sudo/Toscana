{% extends "base.html" %}
{% block title %}Reportes - Xpack{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-graph-up"></i> Reportes y Análisis</h1>
</div>

<!-- Financial Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon" style="background: rgba(79,70,229,0.1); color: var(--primary);">
                    <i class="bi bi-receipt"></i>
                </div>
                <div>
                    <div class="stat-value">RD$ {{ "{:,.0f}".format(summary.get('total_invoiced', 0)) }}</div>
                    <div class="stat-label">Total Facturado</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon" style="background: rgba(16,185,129,0.1); color: var(--success);">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div>
                    <div class="stat-value">RD$ {{ "{:,.0f}".format(summary.get('total_collected', 0)) }}</div>
                    <div class="stat-label">Cobrado</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon" style="background: rgba(239,68,68,0.1); color: var(--danger);">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div>
                    <div class="stat-value">RD$ {{ "{:,.0f}".format(summary.get('total_expenses', 0)) }}</div>
                    <div class="stat-label">Gastos</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon" style="background: rgba(59,130,246,0.1); color: var(--info);">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div>
                    <div class="stat-value">RD$ {{ "{:,.0f}".format(summary.get('net_income', 0)) }}</div>
                    <div class="stat-label">Ingreso Neto</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secondary stats -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body text-center py-3">
                <div style="font-size:1.4rem;font-weight:700;color:var(--warning);">RD$ {{ "{:,.0f}".format(summary.get('total_pending', 0)) }}</div>
                <small style="color:var(--text-muted);">Pendiente de Cobro</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body text-center py-3">
                <div style="font-size:1.4rem;font-weight:700;color:var(--primary);">{{ summary.get('invoice_count', 0) }}</div>
                <small style="color:var(--text-muted);">Facturas Emitidas</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body text-center py-3">
                <div style="font-size:1.4rem;font-weight:700;color:var(--success);">{{ summary.get('collection_rate', 0) }}%</div>
                <small style="color:var(--text-muted);">Tasa de Cobro</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body text-center py-3">
                <div style="font-size:1.4rem;font-weight:700;color:var(--info);">{{ summary.get('active_clients', 0) }}</div>
                <small style="color:var(--text-muted);">Clientes Activos</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <!-- Sales Chart -->
    <div class="col-md-8">
        <div class="card" style="height: 100%;">
            <div class="card-header">
                <i class="bi bi-bar-chart" style="color: var(--primary);"></i> Ventas por Período
            </div>
            <div class="card-body">
                <canvas id="salesChart" style="max-height: 280px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Overdue Summary -->
    <div class="col-md-4">
        <div class="card" style="height: 100%;">
            <div class="card-header">
                <i class="bi bi-exclamation-triangle" style="color: var(--warning);"></i> Cuentas Vencidas
            </div>
            <div class="card-body">
                {% set max_overdue = [overdue_30, overdue_60, overdue_90] | max or 1 %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small style="color: var(--gray-500);">+30 días</small>
                        <strong style="color: var(--warning);">RD$ {{ "{:,.0f}".format(overdue_30) }}</strong>
                    </div>
                    <div class="progress" style="height: 6px; border-radius: 3px;">
                        <div class="progress-bar bg-warning" style="width: {{ (overdue_30 / max_overdue) * 100 }}%;"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small style="color: var(--gray-500);">+60 días</small>
                        <strong style="color: var(--danger);">RD$ {{ "{:,.0f}".format(overdue_60) }}</strong>
                    </div>
                    <div class="progress" style="height: 6px; border-radius: 3px;">
                        <div class="progress-bar bg-danger" style="width: {{ (overdue_60 / max_overdue) * 100 }}%;"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small style="color: var(--gray-500);">+90 días</small>
                        <strong style="color: var(--danger);">RD$ {{ "{:,.0f}".format(overdue_90) }}</strong>
                    </div>
                    <div class="progress" style="height: 6px; border-radius: 3px;">
                        <div class="progress-bar bg-danger" style="width: {{ (overdue_90 / max_overdue) * 100 }}%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <!-- Top Clients -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people" style="color: var(--primary);"></i> Clientes Principales
            </div>
            <div class="card-body">
                {% if sales_by_client %}
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Facturado</th>
                                <th>Pagado</th>
                                <th>Pendiente</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in sales_by_client[:10] %}
                            <tr>
                                <td data-label="Cliente">
                                    <div style="font-weight:600;">{{ c.client_name or 'N/A' }}</div>
                                    <small style="color:var(--text-muted);">Apto {{ c.unit_number or '?' }}</small>
                                </td>
                                <td data-label="Facturado" style="font-weight: 600;">RD$ {{ "{:,.0f}".format(c.total_spent or 0) }}</td>
                                <td data-label="Pagado" style="color: var(--success);">RD$ {{ "{:,.0f}".format(c.paid_amount or 0) }}</td>
                                <td data-label="Pendiente" style="color: var(--danger); font-weight: 600;">RD$ {{ "{:,.0f}".format(c.pending_amount or 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state" style="padding: 1.5rem;"><i class="bi bi-inbox"></i><p>Sin datos</p></div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top Services -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-star" style="color: var(--warning);"></i> Servicios Más Vendidos
            </div>
            <div class="card-body">
                {% if sales_by_service %}
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in sales_by_service[:10] %}
                            <tr>
                                <td data-label="Servicio">{{ s.service_name or 'N/A' }}</td>
                                <td data-label="Cantidad">{{ s.times_sold or 0 }}</td>
                                <td data-label="Total" style="font-weight: 600;">RD$ {{ "{:,.0f}".format(s.total_revenue or 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state" style="padding: 1.5rem;"><i class="bi bi-inbox"></i><p>Sin datos</p></div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Accounts Receivable -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-clock-history" style="color: var(--danger);"></i> Cuentas por Cobrar
    </div>
    <div class="card-body">
        {% if accounts_receivable %}
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Factura</th>
                        <th>Cliente</th>
                        <th>Descripción</th>
                        <th>Total</th>
                        <th>Pagado</th>
                        <th>Balance</th>
                        <th>Fecha</th>
                        <th>Días</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ar in accounts_receivable[:30] %}
                    <tr>
                        <td data-label="Factura"><strong>#{{ ar.id }}</strong></td>
                        <td data-label="Cliente">
                            <div style="font-weight:600;">{{ ar.client_name or 'N/A' }}</div>
                            <small style="color:var(--text-muted);">Apto {{ ar.unit_number or '?' }}</small>
                        </td>
                        <td data-label="Descripción"><small>{{ ar.description or '-' }}</small></td>
                        <td data-label="Total">RD$ {{ "{:,.2f}".format(ar.total or 0) }}</td>
                        <td data-label="Pagado" style="color: var(--success);">RD$ {{ "{:,.2f}".format(ar.paid_amount or 0) }}</td>
                        <td data-label="Balance" style="font-weight: 700; color: var(--danger);">RD$ {{ "{:,.2f}".format(ar.balance or 0) }}</td>
                        <td data-label="Fecha"><small>{{ ar.issued_date or '-' }}</small></td>
                        <td data-label="Días">
                            {% set days = ar.days_pending or 0 %}
                            <span class="badge-status {% if days > 60 %}badge-overdue{% elif days > 30 %}badge-pending{% else %}badge-active{% endif %}">
                                {{ days }} días
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="padding: 1.5rem;">
            <i class="bi bi-check-circle" style="color: var(--success);"></i>
            <p>No hay cuentas por cobrar pendientes</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Sales by Period Chart
const salesData = {{ sales_by_period | tojson }};
if (salesData && salesData.length > 0) {
    const ctx = document.getElementById('salesChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: salesData.map(d => d.period || ''),
                datasets: [{
                    label: 'Facturado',
                    data: salesData.map(d => d.total_amount || 0),
                    backgroundColor: 'rgba(79,70,229,0.7)',
                    borderRadius: 6
                }, {
                    label: 'Cobrado',
                    data: salesData.map(d => d.collected || d.paid_amount || 0),
                    backgroundColor: 'rgba(16,185,129,0.7)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: v => 'RD$' + v.toLocaleString() } }
                }
            }
        });
    }
}
</script>
{% endblock %}
